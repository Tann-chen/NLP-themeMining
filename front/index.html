<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Theme Analysis Demo</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
<div class="container">
  <div class="col-sm-6">
    <div id="pie_chart_node"></div>
  </div>
  <div class="col-sm-6">
    <div id="bar_chart_node"></div>
  </div>
</div>

<div class="container">
  <div class="col-sm-12" style="border: solid black 1px">
    <div id="carousel-example-generic" class="carousel slide" data-ride="carousel" style="height: 300px">
      <!-- Indicators -->
      <ol class="carousel-indicators">
        <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
        <li data-target="#carousel-example-generic" data-slide-to="1"></li>
        <li data-target="#carousel-example-generic" data-slide-to="2"></li>
      </ol>

      <!-- Wrapper for slides -->
      <div class="carousel-inner" role="listbox">
        <div class="item active">
          ....
        </div>
        <div class="item">
          ...
        </div>
      </div>

      <!-- Controls -->
      <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
  </div>
</div>

<div id="menus">
    <div class="bottom-menus" style="bottom:90px">
        <button type="button" data-toggle="modal" data-target="#point_chart_modal">
            <img src="img/icon_pc.png" width="30px" height="30px"/>
        </button>
    </div>
    <div class="bottom-menus" style="bottom:155px;">
        <button type="button" data-toggle="modal" data-target="#line_chart_modal">
            <img src="img/icon_lc.png" width="30px" height="30px"/>
        </button>
    </div>
    <div class="bottom-menus" style="bottom:25px;">
        <button type="button" data-toggle="modal" data-target="#heat_chart_modal">
            <img src="img/color_grid.png" width="30px" height="30px"/>
        </button>
    </div>
<div>


<!-- point chart modal -->
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="LargeModalLabel1" id="point_chart_modal">
    <div class="modal-dialog" role="document" style="width: 1500px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="LargeModalLabel1">Token Distribution Details</h4>
          </div>
          <div class="modal-body" width="1500px" height="1000px">
            <div id="point_chart_node"></div>
          </div>
        </div>
      </div>
</div>

<!-- lines chart modal -->
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="LargeModalLabel2" id="line_chart_modal">
    <div class="modal-dialog" role="document" style="width: 1500px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="LargeModalLabel2">Number of Clusters Analysis</h4>
          </div>
          <div class="modal-body" width="1500px" height="1000px">
            <div id="line_chart_node"></div>
          </div>
        </div>
      </div>
</div>

<!-- heat chart modal -->
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="LargeModalLabel2" id="heat_chart_modal">
    <div class="modal-dialog" role="document" style="width: 1500px;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="LargeModalLabel2">Theme Silimilarities with Question</h4>
          </div>
          <div class="modal-body" width="1500px" height="1000px">
            <div id="heat_chart_node"></div>
          </div>
        </div>
      </div>
</div>

</body>
</html>
<script src='js/jquery-1.11.3.min.js'></script>
<script src='js/bootstrap.min.js'></script>
<script src="js/g2.min.js"></script>
<script src="js/data-set.min.js"></script>
<script type="text/javascript">
//Fixing iframe window.innerHeight0 in Safari
document.body.clientHeight;

var _isload_pointchart = false;
var _isload_linechart = false;
var _isload_heatchart = false;

var _DataSet = DataSet;
var DataView = _DataSet.DataView;

//data
var pie_data = [
    { item: "theme1", count: 35 },
    { item: "theme2", count: 23 },
    { item: "theme3", count: 17 },
    { item: "theme4", count: 13 },
    { item: "theme5", count: 9 }
];

var bar_data = [
    { token: "token1", count: 8 },
    { token: "token2", count: 25 },
    { token: "token3", count: 6 },
    { token: "token4", count: 12 },
    { token: "token5", count: 21 },
    { token: "token6", count: 20 },
    { token: "token7", count: 33 },
    { token: "token8", count: 18 }
];

/////////////////////////////////

$(function() {
    //get init data
    $.ajax({
        type: "get",
        url: "/api/init",
        dataType: "json",
        success: function(resp) {
            render_pie_chart(resp.pie_chart_data);
            render_bar_chart(resp.bar_chart_data);
            adjust_screen();
        },
        error: function(resp) {
            alert("Init Error !");
        }
    });

    //event bindings
    $(window).resize(function() {
        adjust_screen();
    });
});

$("#point_chart_modal").on("shown.bs.modal", function(e) {
    if (!_isload_pointchart) {
        loading_points_chart();
        _isload_pointchart = true;
    }
});

$("#line_chart_modal").on("shown.bs.modal", function(e) {
    if (!_isload_linechart) {
        loading_lines_chart();
        _isload_linechart = true;
    }
});

$("#heat_chart_modal").on("shown.bs.modal", function(e) {
    if (!_isload_heatchart) {
        loading_heat_chart();
        _isload_heaetchart = true;
    }
});

function adjust_screen() {
    var window_width = window.innerWidth;
    var window_height = window.innerHeight;
    $("#point_chart_modal")
        .find(".modal-dialog")
        .css("width", window_width * 0.85 + "px");

    $("#line_chart_modal")
        .find(".modal-dialog")
        .css("width", window_width * 0.85 + "px");

    $("#heat_chart_modal")
        .find(".modal-dialog")
        .css("width", window_width * 0.8 + "px");
}

function render_pie_chart(data) {
    var dv = new DataView();
    dv.source(data).transform({
        type: "percent",
        field: "count",
        dimension: "item",
        as: "percent"
    });

    var pie_chart = new G2.Chart({
        container: "pie_chart_node",
        forceFit: true,
        height: window.innerHeight * 0.6
    });

    pie_chart.source(dv, {
        percent: {
            formatter: function formatter(val) {
                val = val.toFixed(2) * 100 + "%";
                return val;
            }
        }
    });

    pie_chart.coord("theta", {
        radius: 0.75
    });

    pie_chart.legend(false);
    pie_chart.tooltip(false);
    pie_chart
        .intervalStack()
        .position("percent")
        .color("item")
        .label("percent", {
            formatter: function formatter(val, item) {
                return item.point.item + ": " + val;
            }
        })
        .style({
            lineWidth: 1,
            stroke: "#fff"
        });

    pie_chart.on("plotclick", function(selected) {
        console.log(selected);
        var selected_theme = selected.data._origin.item;
        $.ajax({
            type: "get",
            url: "/api/data/bar_chart",
            dataType: "json",
            success: function(resp) {
                render_bar_chart(resp);
            },
            error: function(resp) {
                alert("Internet Error !");
            }
        });
    });

    pie_chart.render();
}

function render_bar_chart(data) {
    var bar_chart = new G2.Chart({
        container: "bar_chart_node",
        forceFit: true,
        height: window.innerHeight * 0.6
    });

    bar_chart.source(data);
    var max_count = 0;
    for (var i in data) {
        if (data[i].count > max_count) {
            max_count = data[i].count;
        }
    }
    interv = 0;
    if (max_count < 20) {
        interv = 2;
    } else if (max_count <= 50) {
        interv = 5;
    } else {
        interv = 10;
    }
    bar_chart.scale("count", {
        tickInterval: interv
    });
    bar_chart.interval().position("token*count");
    bar_chart.render();
}

function loading_lines_chart() {
    $.ajax({
        type: "get",
        url: "/api/data/line_char",
        dataType: "json",
        success: function(resp) {
            var data = resp;
            var dv = new DataView();
            dv.source(data).transform({
                type: "fold",
                fields: ["elobow", "SC_score"],
                key: "method",
                value: "score"
            });
            var chart = new G2.Chart({
                container: "line_chart_node",
                forceFit: true,
                height: window.innerHeight * 0.85
            });
            chart.source(dv, {
                num_cluster: {
                    range: [0, 1]
                }
            });
            chart.tooltip({
                crosshairs: {
                    type: "line"
                }
            });
            chart.axis("score", {
                label: {
                    formatter: function formatter(val) {
                        return val;
                    }
                }
            });
            chart
                .line()
                .position("num_cluster*score")
                .color("method");
            chart
                .point()
                .position("num_cluster*score")
                .color("method")
                .size(4)
                .shape("circle")
                .style({
                    stroke: "#fff",
                    lineWidth: 1
                });
            chart.render();
        },
        error: function(resp) {
            alert("Internet Error !");
        }
    });
}

function loading_heat_chart() {
    $.ajax({
        type: "get",
        url: "/api/data/grid_chart",
        dataType: "json",
        success: function(resp) {
            var grid_data = resp.similarity;
            var lst_x = resp.themes;
            var lst_y = resp.query_tokens;

            var source = [];
            for (var i = 0; i < grid_data.length; i++) {
                var item = grid_data[i];
                var obj = {};
                obj.theme = item[0];
                obj.token = item[1];
                obj.similarity = item[2];
                source.push(obj);
            }

            var chart = new G2.Chart({
                id: "heat_chart_node",
                forceFit: true,
                height: window.innerHeight * 0.83
            });

            chart.source(source, {
                theme: {
                    type: "cat",
                    values: lst_x
                },
                token: {
                    type: "cat",
                    values: lst_y
                }
            });
            chart.axis("theme", {
                tickLine: null,
                grid: {
                    align: "center",
                    lineStyle: {
                        lineWidth: 1,
                        lineDash: null,
                        stroke: "#f0f0f0"
                    }
                }
            });

            chart.axis("token", {
                title: null,
                grid: {
                    align: "center",
                    lineStyle: {
                        lineWidth: 1,
                        lineDash: null,
                        stroke: "#f0f0f0"
                    },
                    showFirstLine: true
                }
            });

            chart
                .polygon()
                .position("theme*token")
                .color("similarity", "#BAE7FF-#1890FF-#0050B3")
                .label("similarity", {
                    offset: -2,
                    textStyle: {
                        fill: "#fff",
                        shadowBlur: 2,
                        shadowColor: "rgba(0, 0, 0, .45)"
                    }
                })
                .style({
                    lineWidth: 1,
                    stroke: "#fff"
                });
            chart.render();
        },
        error: function(resp) {
            alert("Internet Error !");
        }
    });
}

function loading_points_chart() {
    var point_data = [
        { theme: "male", token: "word", x: 179.1, y: 79.1 },
        { theme: "male", token: "word", x: 190.5, y: 98.2 },
        { theme: "male", token: "word", x: 177.8, y: 84.1 },
        { theme: "male", token: "word", x: 180.3, y: 83.2 },
        { theme: "male", token: "word", x: 180.3, y: 83.2 }
    ];

    var point_chart = new G2.Chart({
        container: "point_chart_node",
        forceFit: true,
        height: window.innerHeight * 0.8
    });

    point_chart.source(point_data);
    point_chart.tooltip({
        showTitle: false,
        crosshairs: {
            type: "cross"
        },
        itemTpl:
            '<li data-index={index} style="margin-bottom:4px;">' +
            '<span style="background-color:{color};" class="g2-tooltip-marker"></span>' +
            "{name}<br/>" +
            "{value}" +
            "</li>"
    });

    point_chart
        .point()
        .position("x*y")
        .color("theme")
        .size(4)
        .opacity(0.65)
        .shape("circle")
        .tooltip("token*x*y", function(token, x, y) {
            return {
                name: token,
                value: x + ", " + y
            };
        });
    point_chart.render();
}
</script>
